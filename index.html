<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Markaz Academy | Result Portal</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Dancing+Script:wght@600&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #7c4d3a; --dark: #1e293b; --bg: #f8fafc; --light: #f1f5f9; }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Inter', sans-serif; }
        body { background: var(--bg); color: var(--dark); padding-bottom: 50px; }
        
        /* --- HELPER CLASSES --- */
        .hidden { display: none; }
        .no-print { padding: 15px 5%; background: white; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .btn { padding: 10px 15px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 0.9rem; transition: 0.2s; margin-right: 5px; }
        .btn:hover { opacity: 0.9; }
        .btn-save { background: #16a34a; color: white; }
        .btn-danger { background: #dc2626; color: white; }
        .btn-view { background: var(--primary); color: white; }
        .btn-edit { background: #f59e0b; color: white; }
        .btn-print-all { background: #2563eb; color: white; padding: 12px 20px; font-size: 1rem; }
        
        /* Default Logo Placeholder (Gray Box if no logo) */
        .school-logo { 
            width: 80px; 
            height: 80px; 
            object-fit: contain; 
            display: block; 
            margin: 0 auto 10px; 
            background: #eee; 
            border-radius: 50%; 
        } 

        /* --- LOGIN PORTAL --- */
        #login-screen { height: 100vh; display: flex; align-items: center; justify-content: center; background: #2d1b14; }
        .login-box { background: white; padding: 30px; border-radius: 12px; width: 320px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }

        /* --- DASHBOARD --- */
        .container { max-width: 1200px; margin: 30px auto; padding: 0 20px; }
        .card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 8px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .grid-inputs { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-top: 15px; align-items: center; }
        input { padding: 12px; border: 1px solid #cbd5e1; border-radius: 6px; width: 100%; outline: none; font-size: 1rem; }
        input:focus { border-color: var(--primary); }

        /* Dashboard Table */
        .dash-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        .dash-table th, .dash-table td { border: 1px solid #e2e8f0; padding: 12px; text-align: center; font-size: 0.95rem; }
        .dash-table th { background: var(--light); color: var(--primary); font-weight: 700; }

        /* --- REPORT CARD DESIGN (760px COMPACT SIZE) --- */
        .report-card { 
            background: white; 
            padding: 30px; 
            border: 4px double var(--primary); 
            width: 760px; 
            margin: auto; 
            margin-bottom: 50px; 
            page-break-after: always; 
        }
        
        .report-header-flex { display: flex; justify-content: space-between; align-items: center; border-bottom: 3px solid var(--primary); padding-bottom: 10px; margin-bottom: 15px; }
        .header-text { text-align: center; flex-grow: 1; }
        .header-text h1 { font-size: 1.8rem; margin-bottom: 0; color: var(--primary); line-height: 1; }
        .arabic-text { font-size: 1.4rem; color: #000; font-weight: 700; margin: 5px 0 8px; font-family: 'Arial', sans-serif; }
        .header-text p { font-size: 0.95rem; font-style: italic; color: #555; }
        .header-text h3 { font-size: 1.2rem; margin-top: 5px; text-transform: uppercase; letter-spacing: 1px; }
        
        /* Logo on Report Sheet */
        .logo-small { width: 75px; height: 75px; object-fit: contain; } 

        .student-info-box { display: flex; justify-content: space-between; margin-bottom: 15px; font-weight: 700; background: #f1f5f9; padding: 10px; border-radius: 8px; font-size: 0.95rem; border: 1px solid #ddd; }
        
        .report-table { width: 100%; border-collapse: collapse; margin-bottom: 15px; }
        .report-table th, .report-table td { border: 2px solid #333; padding: 8px 5px; text-align: center; font-size: 0.95rem; }
        .report-table th { background: #e2e8f0; color: #000; text-transform: uppercase; }

        .summary-container { display: grid; grid-template-columns: 1fr 2fr; gap: 15px; margin-bottom: 15px; }
        .summ-box { border: 2px solid #333; padding: 10px; border-radius: 6px; font-size: 0.95rem; }

        .grade-key { border: 2px solid #333; display: flex; font-size: 0.85rem; margin-bottom: 15px; }
        .key-item { flex: 1; text-align: center; padding: 5px; border-right: 1px solid #333; background: #f8fafc; }
        .key-item:last-child { border-right: none; }
        .key-grade { font-weight: 800; color: var(--primary); display: block; font-size: 1rem; }

        .sig-box { display: flex; justify-content: space-between; margin-top: 20px; padding-top: 5px; margin-bottom: 0px; }
        .sig-block { text-align: center; width: 40%; }
        .sig-line { border-bottom: 2px solid #000; height: 30px; margin-top: 5px; }
        .stamp { font-family: 'Dancing Script', cursive; color: var(--primary); font-size: 1.2rem; transform: rotate(-5deg); border: 2px solid var(--primary); padding: 5px 15px; border-radius: 12px; display: inline-block; margin-top: 10px; font-weight: bold; }

        /* --- PRINT SETTINGS --- */
        @media print {
            @page { size: A4 portrait; margin: 0.5cm; }
            body { background: white; padding: 0; }
            .no-print { display: none !important; }
            .container { max-width: 100%; margin: 0; padding: 0; }
            
            .report-card { 
                width: 100% !important; 
                max-width: 100%; 
                margin: 0; 
                padding: 15px 20px !important; 
                border: 3px double var(--primary); 
                page-break-after: always;
                height: auto; 
                display: block;
            }
            .header-text h1 { font-size: 1.6rem; }
            .arabic-text { font-size: 1.3rem; }
            .logo-small { width: 70px; height: 70px; }
            .sig-box { margin-bottom: 0; padding-bottom: 0; }
        }
    </style>
</head>
<body>

<div id="login-screen">
    <div class="login-box">
        <img id="loginLogo" src="" alt="Logo" class="school-logo">
        <h2 style="color: var(--primary); margin: 10px 0; font-size: 1.5rem;">Staff Portal</h2>
        <input type="password" id="staffKey" placeholder="Password: Admin only" style="margin-top: 15px;">
        <button class="btn btn-save" style="width: 100%; margin-top: 15px;" onclick="checkLogin()">Login</button>
    </div>
</div>

<div id="dashboard" class="hidden">
    <nav class="no-print" style="display: flex; justify-content: space-between; align-items: center;">
        <div style="display:flex; align-items:center; gap:15px;">
            <img id="dashLogo" src="" alt="Logo" style="height:45px;">
            <h2 style="color: var(--primary); font-size: 1.5rem;">Portal Dashboard</h2>
        </div>
        <button class="btn btn-danger" onclick="location.reload()">Logout</button>
    </nav>

    <div class="container">
        <div class="card no-print">
            <div style="display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; padding-bottom: 15px; margin-bottom: 15px;">
                <h3>1. Configuration & Branding</h3>
                <div style="text-align: right;">
                    <label style="font-size: 0.9rem; font-weight: bold; margin-right: 10px;">Set School Logo:</label>
                    <input type="file" id="logoUpload" accept="image/*" onchange="uploadLogo()" style="width: auto; padding: 5px;">
                </div>
            </div>
            
            <div class="grid-inputs">
                <input type="text" id="className" placeholder="Class Name (e.g. Primary 5)">
                <input type="text" id="teacherName" placeholder="Class Teacher Name">
                <input type="text" id="headmasterName" placeholder="Headmaster Name">
                <input type="text" id="subsList" placeholder="Subjects (Comma separated)">
            </div>
            
            <div style="display: flex; justify-content: space-between; margin-top: 15px;">
                <button class="btn btn-save" onclick="setupFields()">Generate Entry Rows</button>
                <button class="btn btn-print-all" onclick="printAllReports()">üñ®Ô∏è Print All Report Sheets</button>
            </div>
        </div>

        <div class="card no-print" id="entry-card">
            <h3 id="entry-title">2. Marks Entry</h3>
            <input type="text" id="stuName" placeholder="Student Full Name" style="border: 2px solid var(--primary); font-weight: bold;">
            <div id="dynamic-fields"></div>
            <button id="saveBtn" class="btn btn-save" style="width: 100%; margin-top: 20px; display: none;" onclick="saveStudentRecord()">Save Record</button>
            <button id="cancelBtn" class="btn btn-danger" style="width: 100%; margin-top: 10px; display: none;" onclick="cancelEdit()">Cancel Edit</button>
        </div>

        <div class="card">
            <h3>3. Class Broadsheet</h3>
            <table class="dash-table">
                <thead>
                    <tr>
                        <th>Pos</th>
                        <th>Name</th>
                        <th>Total</th>
                        <th>Avg</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>
    </div>
</div>

<div id="report-view" class="hidden container">
    <button class="btn no-print" style="background:#333; color:white; margin-bottom:20px;" onclick="closeReport()">‚Üê Back to Dashboard</button>
    <div id="report-content"></div>
</div>

<script>
    let students = JSON.parse(localStorage.getItem('markaz_v17_db')) || [];
    let savedLogo = localStorage.getItem('markaz_logo_data') || ""; // Load logo from memory
    let currentSubs = [];
    let editIndex = -1;

    // Apply Logo on Load
    window.onload = function() {
        if(savedLogo) {
            document.getElementById('loginLogo').src = savedLogo;
            document.getElementById('dashLogo').src = savedLogo;
        } else {
            // Placeholder text if no logo
            document.getElementById('loginLogo').style.display = 'none'; 
        }
    };

    // --- LOGO UPLOAD FUNCTION ---
    function uploadLogo() {
        const file = document.getElementById('logoUpload').files[0];
        if(!file) return;

        const reader = new FileReader();
        reader.onloadend = function() {
            savedLogo = reader.result; // This is the Base64 string
            localStorage.setItem('markaz_logo_data', savedLogo); // Save to memory
            
            // Update images immediately
            document.getElementById('loginLogo').src = savedLogo;
            document.getElementById('loginLogo').style.display = 'block';
            document.getElementById('dashLogo').src = savedLogo;
            
            alert("Logo Uploaded & Saved! It will appear on all reports now.");
        }
        reader.readAsDataURL(file);
    }

    function checkLogin() {
        if(document.getElementById('staffKey').value === "Markaz") {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('dashboard').classList.remove('hidden');
            renderTable();
        } else { alert("Incorrect Access Code"); }
    }

    function setupFields() {
        const subInput = document.getElementById('subsList').value;
        if(!subInput) return alert("Please enter subjects first.");
        currentSubs = subInput.split(',').map(s => s.trim());
        renderEntryRows();
        document.getElementById('saveBtn').style.display = 'block';
    }

    function renderEntryRows() {
        const div = document.getElementById('dynamic-fields');
        div.innerHTML = '';
        currentSubs.forEach(s => {
            div.innerHTML += `
                <div class="grid-inputs subject-row" data-sname="${s}">
                    <span style="font-weight:600">${s}</span>
                    <input type="number" class="c1" placeholder="15">
                    <input type="number" class="c2" placeholder="15">
                    <input type="number" class="c3" placeholder="10">
                    <input type="number" class="ex" placeholder="60">
                </div>`;
        });
    }

    function getGrade(score) {
        if(score >= 70) return 'A';
        if(score >= 60) return 'B';
        if(score >= 50) return 'C';
        if(score >= 45) return 'D';
        return 'F';
    }

    function saveStudentRecord() {
        const name = document.getElementById('stuName').value;
        if(!name) return alert("Student Name is required");

        let record = { 
            name, 
            class: document.getElementById('className').value,
            teacher: document.getElementById('teacherName').value,
            headmaster: document.getElementById('headmasterName').value,
            marks: [], 
            grandTotal: 0 
        };
        
        document.querySelectorAll('.subject-row').forEach(row => {
            const m = {
                sub: row.dataset.sname,
                c1: Number(row.querySelector('.c1').value) || 0,
                c2: Number(row.querySelector('.c2').value) || 0,
                c3: Number(row.querySelector('.c3').value) || 0,
                ex: Number(row.querySelector('.ex').value) || 0
            };
            m.total = m.c1 + m.c2 + m.c3 + m.ex;
            m.grade = getGrade(m.total);
            record.grandTotal += m.total;
            record.marks.push(m);
        });

        record.avg = record.grandTotal / record.marks.length;
        setComment(record);

        if(editIndex > -1) {
            students[editIndex] = record;
            alert("Student Updated Successfully!");
            cancelEdit();
        } else {
            students.push(record);
            alert("Student Saved!");
        }

        students.sort((a, b) => b.avg - a.avg);
        localStorage.setItem('markaz_v17_db', JSON.stringify(students));
        renderTable();
        clearInputs();
    }

    function setComment(record) {
        if(record.avg >= 80) record.comment = "An excellent result. The student shows exceptional mastery.";
        else if(record.avg >= 70) record.comment = "Very good performance. Keep up the hard work and dedication.";
        else if(record.avg >= 60) record.comment = "Good result, but there is still room for improvement.";
        else if(record.avg >= 50) record.comment = "Average performance. Needs to focus more during CA tests.";
        else record.comment = "Below expected standard. Parent-teacher meeting recommended.";
    }

    function editStudent(i) {
        editIndex = i;
        const s = students[i];
        document.getElementById('stuName').value = s.name;
        document.querySelectorAll('.subject-row').forEach(row => {
            const subName = row.dataset.sname;
            const mark = s.marks.find(m => m.sub === subName);
            if(mark) {
                row.querySelector('.c1').value = mark.c1;
                row.querySelector('.c2').value = mark.c2;
                row.querySelector('.c3').value = mark.c3;
                row.querySelector('.ex').value = mark.ex;
            }
        });
        document.getElementById('saveBtn').innerText = "Update Student Record";
        document.getElementById('saveBtn').style.background = "#f59e0b";
        document.getElementById('cancelBtn').style.display = "block";
        document.getElementById('entry-title').innerText = "Editing: " + s.name;
        document.getElementById('entry-card').scrollIntoView({behavior: "smooth"});
    }

    function cancelEdit() {
        editIndex = -1;
        clearInputs();
        document.getElementById('saveBtn').innerText = "Save Record";
        document.getElementById('saveBtn').style.background = "#16a34a";
        document.getElementById('cancelBtn').style.display = "none";
        document.getElementById('entry-title').innerText = "2. Marks Entry";
    }

    function clearInputs() {
        document.getElementById('stuName').value = '';
        document.querySelectorAll('.subject-row input').forEach(i => i.value = '');
    }

    function renderTable() {
        const body = document.getElementById('tableBody');
        body.innerHTML = '';
        students.forEach((s, i) => {
            body.innerHTML += `
                <tr>
                    <td>${i+1}</td>
                    <td>${s.name}</td>
                    <td>${s.grandTotal}</td>
                    <td>${s.avg.toFixed(1)}%</td>
                    <td class="no-print">
                        <button class="btn btn-view" onclick="viewSingleReport(${i})">View</button>
                        <button class="btn btn-edit" onclick="editStudent(${i})">Edit</button>
                        <button class="btn btn-danger" onclick="deleteStudent(${i})">Del</button>
                    </td>
                </tr>`;
        });
    }

    function deleteStudent(i) {
        if(confirm("Are you sure you want to delete this record?")) {
            students.splice(i, 1);
            localStorage.setItem('markaz_v17_db', JSON.stringify(students));
            renderTable();
        }
    }

    function generateReportHTML(s, i) {
        // Use saved logo or a blank pixel if none
        let logoSrc = savedLogo || ""; 
        let logoImg = logoSrc ? `<img src="${logoSrc}" class="logo-small">` : `<div style="width:75px;height:75px;background:#eee;"></div>`;

        let marksRows = s.marks.map(m => `
            <tr>
                <td style="text-align:left; padding-left:10px; font-weight:600">${m.sub}</td>
                <td>${m.c1 > 0 ? m.c1 : '-'}</td>
                <td>${m.c2 > 0 ? m.c2 : '-'}</td>
                <td>${m.c3 > 0 ? m.c3 : '-'}</td>
                <td>${m.ex > 0 ? m.ex : '-'}</td>
                <td style="font-weight:bold; background:#f8fafc">${m.total}</td>
                <td style="color:var(--primary); font-weight:bold">${m.grade}</td>
            </tr>`).join('');

        return `
        <div class="report-card">
            <div class="report-header-flex">
                ${logoImg}
                <div class="header-text">
                    <h1>MARKAZ ACADEMY NGUROJE</h1>
                    <div class="arabic-text">ŸÖÿØÿ±ÿ≥ÿ© ŸÖÿ±ŸÉÿ≤ ÿßŸÑÿ£ŸÉÿßÿØŸäŸÖŸäÿ© ÿ∫ÿ±Ÿàÿ¨Ÿä</div>
                    <p>"You will not attain knowledge without patience"</p>
                    <h3>TERMINAL RESULT SHEET</h3>
                </div>
                ${logoImg}
            </div>

            <div class="student-info-box">
                <div>NAME: <span style="color: var(--primary);">${s.name.toUpperCase()}</span></div>
                <div>CLASS: <span>${s.class}</span></div>
                <div>POSITION: <span>${i+1} out of ${students.length}</span></div>
            </div>

            <table class="report-table">
                <thead>
                    <tr>
                        <th style="text-align: left; width: 30%;">SUBJECT</th>
                        <th>1st CA</th><th>2nd CA</th><th>3rd CA</th><th>EXAM</th><th>TOTAL</th><th>GRADE</th>
                    </tr>
                </thead>
                <tbody>${marksRows}</tbody>
            </table>

            <div class="summary-container">
                <div class="summ-box" style="background: #f8fafc;">
                    <p><strong>Grand Total:</strong> ${s.grandTotal}</p>
                    <p style="margin-top:5px;"><strong>Percentage:</strong> ${s.avg.toFixed(1)}%</p>
                </div>
                <div class="summ-box" style="background: #fffbf0;">
                    <strong style="color: var(--primary);">  School Management Comment:</strong>
                    <p style="font-style: italic; margin-top: 5px;">${s.comment}</p>
                </div>
            </div>

            <div class="grade-key">
                <div class="key-item"><span class="key-grade">A</span>70-100%<br>Distinction</div>
                <div class="key-item"><span class="key-grade">B</span>60-69%<br>Very Good</div>
                <div class="key-item"><span class="key-grade">C</span>50-59%<br>Credit</div>
                <div class="key-item"><span class="key-grade">D</span>45-49%<br>Pass</div>
                <div class="key-item"><span class="key-grade">F</span>0-44%<br>Fail</div>
            </div>

            <div class="sig-box">
                <div class="sig-block">
                    <p>Class Teacher: <span style="font-weight:600">${s.teacher}</span></p>
                    <div class="sig-line"></div>
                </div>
                <div class="sig-block">
                    <p>Headmaster: <span style="font-weight:600">${s.headmaster}</span></p>
                    <div class="sig-line"></div>
                    <div class="stamp">Approved</div>
                </div>
            </div>
        </div>`;
    }

    function viewSingleReport(i) {
        document.getElementById('report-content').innerHTML = generateReportHTML(students[i], i) + 
            `<div style="text-align: center; margin-top: 30px;" class="no-print">
                <button class="btn btn-save" onclick="window.print()">Print This Result</button>
            </div>`;
        document.getElementById('dashboard').classList.add('hidden');
        document.getElementById('report-view').classList.remove('hidden');
    }

    function printAllReports() {
        if(students.length === 0) return alert("No students to print!");
        let allHtml = "";
        students.forEach((s, i) => {
            allHtml += generateReportHTML(s, i);
        });
        document.getElementById('report-content').innerHTML = allHtml + 
            `<div style="text-align: center; margin-top: 30px;" class="no-print">
                <button class="btn btn-save" onclick="window.print()">Confirm Print All</button>
            </div>`;
        document.getElementById('dashboard').classList.add('hidden');
        document.getElementById('report-view').classList.remove('hidden');
    }

    function closeReport() {
        document.getElementById('report-view').classList.add('hidden');
        document.getElementById('dashboard').classList.remove('hidden');
    }
</script>
</body>
</html>

